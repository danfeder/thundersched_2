<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cooking Class Scheduler</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/analytics.css">
    <style>
        #unscheduled-classes {
            height: 350px !important;
            max-height: 350px !important;
            overflow-y: auto !important;
            margin-bottom: 10px !important;
            border: 1px solid #eee !important;
            border-radius: 4px !important;
            padding-right: 5px !important;
        }
    </style>
    <script>
        // Simple utility function to set up What-If Analysis when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up What-If Analysis event handlers');
            
            // Direct click handler for What-If button
            document.getElementById('show-what-if-btn').addEventListener('click', function() {
                console.log('What-If button clicked');
                const whatIfModal = document.getElementById('what-if-modal');
                if (whatIfModal) {
                    // Set up the constraint values first
                    setTimeout(function() {
                        // This will run after app.js has initialized
                        if (window.dataManager) {
                            console.log('Setting up constraint values');
                            const config = window.dataManager.getConfig();
                            
                            document.getElementById('what-if-consecutive').value = config.maxConsecutiveClasses;
                            document.getElementById('what-if-consecutive-value').textContent = config.maxConsecutiveClasses;
                            
                            document.getElementById('what-if-daily').value = config.maxClassesPerDay;
                            document.getElementById('what-if-daily-value').textContent = config.maxClassesPerDay;
                            
                            document.getElementById('what-if-weekly-min').value = config.minClassesPerWeek;
                            document.getElementById('what-if-weekly-min-value').textContent = config.minClassesPerWeek;
                            
                            document.getElementById('what-if-weekly-max').value = config.maxClassesPerWeek;
                            document.getElementById('what-if-weekly-max-value').textContent = config.maxClassesPerWeek;
                        }
                    }, 10);
                    
                    // Show the modal
                    whatIfModal.style.display = 'block';
                    console.log('Showing What-If modal');
                    
                    // Reset results
                    document.getElementById('what-if-results').style.display = 'none';
                    document.getElementById('what-if-status').innerHTML = 
                        '<div class="status-message">Adjust constraints and click "Simulate" to see potential impact</div>';
                    document.querySelector('.what-if-advanced-actions').style.display = 'none';
                } else {
                    console.error('What-If modal not found');
                }
            });
            
            // Set up event handlers for the what-if modal buttons (executed after DOM is completely loaded)
            setTimeout(function() {
                console.log('Setting up What-If modal button handlers');
                
                // Simulation button
                document.getElementById('what-if-simulate-btn').addEventListener('click', function() {
                    console.log('Simulate button clicked');
                    // Try multiple ways to find the function, for robustness
                    if (window.runWhatIfSimulation) {
                        console.log('Using window.runWhatIfSimulation');
                        window.runWhatIfSimulation();
                    } else if (window.whatIfAnalysis && window.whatIfAnalysis.runWhatIfSimulation) {
                        console.log('Using window.whatIfAnalysis.runWhatIfSimulation');
                        window.whatIfAnalysis.runWhatIfSimulation();
                    } else {
                        console.error('runWhatIfSimulation function not available, using fallback implementation');
                        
                        // Fallback implementation
                        const resultContainer = document.getElementById('what-if-results');
                        const statusContainer = document.getElementById('what-if-status');
                        const actionContainer = document.querySelector('.what-if-advanced-actions');
                        
                        // Show loading state
                        statusContainer.innerHTML = '<div class="loading-indicator">Running simulation...</div>';
                        resultContainer.style.display = 'none';
                        actionContainer.style.display = 'none';
                        
                        // Get the constraint values
                        const newConstraints = {
                            maxConsecutiveClasses: parseInt(document.getElementById('what-if-consecutive').value),
                            maxClassesPerDay: parseInt(document.getElementById('what-if-daily').value),
                            minClassesPerWeek: parseInt(document.getElementById('what-if-weekly-min').value),
                            maxClassesPerWeek: parseInt(document.getElementById('what-if-weekly-max').value)
                        };
                        
                        // Simple mock result
                        const mockResult = {
                            source: 'fallback',
                            feasible: true,
                            currentClassCount: 10,
                            simulatedClassCount: 10,
                            invalidPlacements: [],
                            metrics: {
                                totalClasses: 10,
                                invalidPlacements: 0,
                                affectedDays: 0
                            }
                        };
                        
                        // Display the results
                        setTimeout(function() {
                            statusContainer.innerHTML = `
                                <div class="status-success">
                                    âœ“ Schedule appears to be feasible with the new constraints (fallback mode)
                                </div>
                            `;
                            
                            resultContainer.innerHTML = `
                                <h4>Impact Analysis (Fallback Mode)</h4>
                                <p>This is a simplified simulation result as the full simulation engine is not available.</p>
                                <table class="impact-table">
                                    <tr>
                                        <th>Constraint</th>
                                        <th>Value</th>
                                    </tr>
                                    <tr>
                                        <td>Max Consecutive Classes</td>
                                        <td>${newConstraints.maxConsecutiveClasses}</td>
                                    </tr>
                                    <tr>
                                        <td>Max Classes Per Day</td>
                                        <td>${newConstraints.maxClassesPerDay}</td>
                                    </tr>
                                    <tr>
                                        <td>Weekly Class Target</td>
                                        <td>${newConstraints.minClassesPerWeek}-${newConstraints.maxClassesPerWeek}</td>
                                    </tr>
                                </table>
                            `;
                            
                            resultContainer.style.display = 'block';
                            actionContainer.style.display = 'flex';
                        }, 1000);
                    }
                });
                
                // Apply button
                document.getElementById('what-if-apply-btn').addEventListener('click', function() {
                    console.log('Apply button clicked');
                    // Try multiple ways to find the function, for robustness
                    if (window.applyWhatIfResults) {
                        console.log('Using window.applyWhatIfResults');
                        window.applyWhatIfResults();
                    } else if (window.whatIfAnalysis && window.whatIfAnalysis.applyWhatIfResults) {
                        console.log('Using window.whatIfAnalysis.applyWhatIfResults');
                        window.whatIfAnalysis.applyWhatIfResults();
                    } else {
                        console.error('applyWhatIfResults function not available, using fallback implementation');
                        
                        // Fallback implementation
                        
                        // Get new constraint values
                        const newConstraints = {
                            maxConsecutiveClasses: parseInt(document.getElementById('what-if-consecutive').value),
                            maxClassesPerDay: parseInt(document.getElementById('what-if-daily').value),
                            minClassesPerWeek: parseInt(document.getElementById('what-if-weekly-min').value),
                            maxClassesPerWeek: parseInt(document.getElementById('what-if-weekly-max').value)
                        };
                        
                        // Try to update the config if dataManager is available
                        if (window.dataManager && window.dataManager.updateConfig) {
                            window.dataManager.updateConfig(newConstraints);
                            
                            // Close the modal
                            document.getElementById('what-if-modal').style.display = 'none';
                            
                            alert('Constraints updated successfully (fallback mode).');
                        } else {
                            alert('Cannot apply changes: dataManager not available in fallback mode.');
                        }
                    }
                });
                
                // Cancel button
                document.getElementById('what-if-cancel-btn').addEventListener('click', function() {
                    document.getElementById('what-if-modal').style.display = 'none';
                });
                
                // Close button
                document.querySelector('#what-if-modal .close').addEventListener('click', function() {
                    document.getElementById('what-if-modal').style.display = 'none';
                });
                
            }, 500); // Give app.js time to initialize
            
            // Set up slider event handlers
            const consecutiveSlider = document.getElementById('what-if-consecutive');
            const consecutiveValue = document.getElementById('what-if-consecutive-value');
            consecutiveSlider.addEventListener('input', function() {
                consecutiveValue.textContent = this.value;
            });
            
            const dailySlider = document.getElementById('what-if-daily');
            const dailyValue = document.getElementById('what-if-daily-value');
            dailySlider.addEventListener('input', function() {
                dailyValue.textContent = this.value;
            });
            
            const weeklyMinSlider = document.getElementById('what-if-weekly-min');
            const weeklyMinValue = document.getElementById('what-if-weekly-min-value');
            const weeklyMaxSlider = document.getElementById('what-if-weekly-max');
            const weeklyMaxValue = document.getElementById('what-if-weekly-max-value');
            
            weeklyMinSlider.addEventListener('input', function() {
                // Ensure min doesn't exceed max
                if (parseInt(this.value) > parseInt(weeklyMaxSlider.value)) {
                    weeklyMaxSlider.value = this.value;
                    weeklyMaxValue.textContent = this.value;
                }
                weeklyMinValue.textContent = this.value;
            });
            
            weeklyMaxSlider.addEventListener('input', function() {
                // Ensure max doesn't go below min
                if (parseInt(this.value) < parseInt(weeklyMinSlider.value)) {
                    weeklyMinSlider.value = this.value;
                    weeklyMinValue.textContent = this.value;
                }
                weeklyMaxValue.textContent = this.value;
            });
        });
    </script>
</head>
<body>
    <header>
        <h1>Cooking Class Scheduler Assistant</h1>
    </header>
    
    <main>
        <div class="container">
            <div class="sidebar">
                <h2>Unscheduled Classes</h2>
                <div id="unscheduled-classes" class="class-list"></div>
                
                <div class="controls">
                    <button id="suggest-next-btn" class="btn">Suggest Next Class</button>
                    <button id="config-btn" class="btn btn-secondary">Configure Constraints</button>
                    <button id="export-btn" class="btn btn-secondary">Export Schedule</button>
                    <button id="manage-classes-btn" class="btn btn-secondary" onclick="window.openClassManager()">Manage Classes</button>
                    <button id="analytics-btn" class="btn btn-secondary">Schedule Analytics</button>
                    <div class="btn-group schedule-management">
                        <button id="save-schedule-btn" class="btn btn-secondary">Save Schedule</button>
                        <button id="load-schedule-btn" class="btn btn-secondary">Load Schedule</button>
                    </div>
                    <div class="teacher-mode-toggle">
                        <input type="checkbox" id="teacher-mode" class="toggle-checkbox">
                        <label for="teacher-mode" class="toggle-label">Teacher Mode</label>
                        <span class="toggle-help" title="Toggle Teacher Mode to mark periods when you're unavailable. These will be considered when scheduling classes.">?</span>
                    </div>
                    <div class="btn-group">
                        <button id="reset-btn" class="btn btn-danger">Reset Schedule</button>
                        <button id="help-btn" class="btn btn-text">Show Help</button>
                    </div>
                    <div class="progress-bar">
                        <div id="schedule-progress" class="progress"></div>
                    </div>
                    <div id="progress-text">0 of 0 classes scheduled</div>
                    
                    <div class="constraint-status">
                        <div id="weekly-constraint-indicator" class="constraint-indicator">
                            <span>Weekly: <span id="week-count">0</span>/<span id="week-limit">12-16</span></span>
                        </div>
                    </div>
                    
                    <div id="message-area" class="message-area"></div>
                </div>
            </div>
            
            <div class="schedule-container">
                <div class="schedule-header">
                    <h2>Weekly Schedule</h2>
                    <div class="week-navigation">
                        <button id="prev-week-btn" class="nav-btn">&lt; Prev Week</button>
                        <div id="current-week-display" class="current-week"></div>
                        <button id="next-week-btn" class="nav-btn">Next Week &gt;</button>
                    </div>
                    <div class="date-picker-container">
                        <label for="start-date">Start Date:</label>
                        <input type="date" id="start-date" class="date-picker">
                    </div>
                </div>
                <div id="schedule-grid" class="schedule-grid"></div>
            </div>
        </div>
    </main>

    <!-- Help Modal -->
    <div id="help-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Cooking Class Scheduler Help</h2>
            <h3>Using the Scheduler</h3>
            <ul>
                <li><strong>Viewing Available Slots:</strong> Click on a class to see available slots (highlighted in green) and conflicts (in red)</li>
                <li><strong>Scheduling a Class:</strong> Drag a class from the sidebar and drop it into an available slot on the grid</li>
                <li><strong>Rescheduling a Class:</strong> Click or drag a scheduled class to see other available slots, then drag it to a new position</li>
                <li><strong>Unscheduling a Class:</strong> Double-click a scheduled class to remove it from the schedule</li>
                <li><strong>Getting Suggestions:</strong> Click "Suggest Next Class" to highlight the most constrained class and its available slots</li>
                <li><strong>Exporting:</strong> Click "Export Schedule" to download the current schedule as a CSV file</li>
                <li><strong>Reset Schedule:</strong> Click "Reset Schedule" to clear all scheduled classes and start over</li>
            </ul>
            
            <h3>Multi-Week Scheduling</h3>
            <ul>
                <li><strong>Navigating Weeks:</strong> Use the "Prev Week" and "Next Week" buttons to move between weeks</li>
                <li><strong>Setting Start Date:</strong> Use the date picker to instantly jump to any week by selecting a date</li>
                <li><strong>Week Display:</strong> The current week's date range is shown above the schedule grid</li>
                <li><strong>Resetting:</strong> The "Reset Schedule" button only resets the currently displayed week</li>
            </ul>
            
            <h3>Scheduling Rules</h3>
            <ul>
                <li>Classes cannot be scheduled during their conflict periods</li>
                <li>Maximum of 4 classes per day (configurable)</li>
                <li>No more than 2 consecutive classes (configurable)</li>
                <li>Weekly teaching load: 12-16 classes total (configurable)</li>
                <li>Each class can only be scheduled once across all weeks</li>
                <li>Classes cannot be scheduled during teacher unavailability periods</li>
            </ul>
            
            <h3>Configurable Constraints</h3>
            <ul>
                <li><strong>Consecutive Class Limit:</strong> You can set the maximum number of consecutive classes allowed</li>
                <li><strong>Daily Class Limit:</strong> You can specify how many classes can be scheduled per day</li>
                <li><strong>Weekly Class Range:</strong> You can set minimum and maximum classes per week targets</li>
                <li><strong>Constraint Configuration:</strong> Click the "Configure Constraints" button to modify these settings</li>
            </ul>
            
            <h3>Teacher Mode</h3>
            <ul>
                <li><strong>Enabling Teacher Mode:</strong> Toggle the "Teacher Mode" switch to mark periods when you're unavailable</li>
                <li><strong>Marking Unavailability:</strong> With Teacher Mode active, click on any unscheduled time slot to mark it as unavailable</li>
                <li><strong>Removing Unavailability:</strong> Click again on a marked slot to make it available again</li>
                <li><strong>Visual Indicators:</strong> Unavailable slots are shown with a yellow background and X mark</li>
                <li><strong>Impact on Scheduling:</strong> Classes cannot be scheduled in periods marked as teacher unavailable</li>
            </ul>
            
            <h3>Schedule Management</h3>
            <ul>
                <li><strong>Saving Schedules:</strong> Click "Save Schedule" to create a named snapshot of your current schedule</li>
                <li><strong>Loading Schedules:</strong> Click "Load Schedule" to view and load previously saved schedules</li>
                <li><strong>Previewing Schedules:</strong> Click "Preview" to view schedule details before loading</li>
                <li><strong>Current Schedule Indicator:</strong> The currently loaded schedule is highlighted and labeled in the list</li>
                <li><strong>Handling Class Changes:</strong> When loading a schedule with class differences, you can:
                    <ul>
                        <li><em>Full Restore:</em> Use class definitions exactly as they were when saved</li>
                        <li><em>Adapt to Current Classes:</em> Keep current class definitions but load compatible placements</li>
                    </ul>
                </li>
                <li><strong>Managing Saved Schedules:</strong> Use the Load Schedule dialog to view, preview, and delete saved schedules</li>
            </ul>
            
            <h3>Class Manager</h3>
            <ul>
                <li><strong>Opening Class Manager:</strong> Click the "Manage Classes" button to open the class manager</li>
                <li><strong>Adding Classes:</strong> Click "Add New Class" to create a new class</li>
                <li><strong>Importing Classes:</strong> Click "Import CSV" to import classes from a CSV file in the format of Class,Monday,Tuesday,Wednesday,Thursday,Friday where each day contains period numbers</li>
                <li><strong>Editing Classes:</strong> Select a class from the list to edit its details</li>
                <li><strong>Setting Conflicts:</strong> Click on periods in the conflict grid to mark times when a class CANNOT be scheduled</li>
                <li><strong>Deleting Classes:</strong> Select a class and click "Delete Class" (only works for unscheduled classes)</li>
                <li><strong>Auto-Naming:</strong> If you leave the class name blank, it will be auto-generated based on grade level</li>
            </ul>
        </div>
    </div>
    
    <!-- Class Manager Modal -->
    <div id="class-manager-modal" class="modal">
        <div class="modal-content class-manager-content">
            <span class="close" onclick="window.closeClassManager()">&times;</span>
            <h2>Class Manager</h2>
            
            <div class="class-manager-container">
                <div class="class-selector">
                    <h3>Classes</h3>
                    <div class="class-list-container">
                        <div id="class-list" class="class-list scrollable"></div>
                    </div>
                    <div class="button-group">
                        <button id="add-class-btn" class="btn">Add New Class</button>
                        <button id="import-csv-btn" class="btn btn-secondary" type="button">Import CSV</button>
                    </div>
                    <div class="button-group class-collection-buttons">
                        <button id="save-class-collection-btn" class="btn btn-secondary">Save Collection</button>
                        <button id="load-class-collection-btn" class="btn btn-secondary">Load Collection</button>
                    </div>
                </div>
                
                <div class="class-editor">
                    <h3>Edit Class</h3>
                    <form id="class-edit-form">
                        <div class="form-group">
                            <label for="class-name">Class Name:</label>
                            <input type="text" id="class-name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="class-grade">Grade Level:</label>
                            <select id="class-grade">
                                <option value="PK">Pre-K</option>
                                <option value="K">Kindergarten</option>
                                <option value="1">1st Grade</option>
                                <option value="2">2nd Grade</option>
                                <option value="3">3rd Grade</option>
                                <option value="4">4th Grade</option>
                                <option value="5">5th Grade</option>
                                <option value="mixed">Mixed Grades</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Conflict Periods:</label>
                            <div class="conflict-grid-container">
                                <div id="conflict-grid" class="conflict-grid"></div>
                            </div>
                            <div class="conflict-help">Click on periods when this class CANNOT be scheduled</div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" id="save-class-btn" class="btn">Save Class</button>
                            <button type="button" id="delete-class-btn" class="btn btn-danger">Delete Class</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div id="config-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; padding: 20px 0;">
        <div class="modal-content" style="width: 600px; max-width: 90%; margin: 20px auto; background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; padding: 25px; overflow-y: auto; max-height: 80vh;">
            <span class="close" style="position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer;">&times;</span>
            <h2 style="margin-top: 5px; margin-bottom: 20px;">Scheduling Constraints</h2>
            
            <form id="config-form" style="display: flex; flex-direction: column; padding-bottom: 60px;">
                <div class="form-group">
                    <label for="max-consecutive">Maximum Consecutive Classes:</label>
                    <input type="number" id="max-consecutive" min="1" max="8" value="2">
                    <div class="help-text">Maximum number of classes that can be scheduled in a row</div>
                    <div class="tooltip">Recommended: 2-3. Higher values may lead to teacher fatigue.</div>
                </div>
                
                <div class="form-group">
                    <label for="max-daily">Maximum Classes Per Day:</label>
                    <input type="number" id="max-daily" min="1" max="8" value="4">
                    <div class="help-text">Maximum number of classes per day</div>
                    <div class="tooltip">Recommended: 3-4. Higher values may overload daily schedule.</div>
                </div>
                
                <div class="form-group">
                    <label for="min-weekly">Minimum Classes Per Week:</label>
                    <input type="number" id="min-weekly" min="0" max="40" value="12">
                    <div class="help-text">Target minimum classes per week</div>
                    <div class="tooltip">Recommended: 12-14. This is a target, not strictly enforced.</div>
                </div>
                
                <div class="form-group">
                    <label for="max-weekly">Maximum Classes Per Week:</label>
                    <input type="number" id="max-weekly" min="1" max="40" value="16">
                    <div class="help-text">Maximum classes allowed per week</div>
                    <div class="tooltip">Recommended: 14-16. Higher values may exceed teaching capacity.</div>
                </div>
                
                <div id="config-warning-container"></div>
                
                <div class="form-actions" style="padding: 15px 0; margin-top: 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px;">
                    <button type="submit" class="btn">Save Configuration</button>
                    <button type="button" id="reset-config-btn" class="btn btn-secondary">Reset to Defaults</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Confirmation Dialog Modal -->
    <div id="confirm-dialog" class="modal">
        <div class="modal-content">
            <h2 id="confirm-title">Confirmation</h2>
            <p id="confirm-message"></p>
            <div id="confirm-details"></div>
            <div class="dialog-actions" id="confirm-buttons">
                <!-- Buttons will be added dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Save Schedule Modal -->
    <div id="save-schedule-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Save Schedule</h2>
            <form id="save-schedule-form">
                <div class="form-group">
                    <label for="schedule-name">Schedule Name*</label>
                    <input type="text" id="schedule-name" required>
                </div>
                <div class="form-group">
                    <label for="schedule-description">Description (optional)</label>
                    <textarea id="schedule-description"></textarea>
                </div>
                <div class="dialog-actions">
                    <button type="submit" class="btn">Save</button>
                    <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Schedule Modal -->
    <div id="load-schedule-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Saved Schedules</h2>
            <div id="saved-schedules-list" class="saved-schedules-container">
                <!-- Saved schedules will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- Preview Schedule Modal -->
    <div id="preview-schedule-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Schedule Preview</h2>
            <div id="preview-content">
                <!-- Preview content will be added here dynamically -->
            </div>
            <div class="dialog-actions">
                <button id="load-preview-btn" class="btn">Load This Schedule</button>
                <button class="btn btn-secondary cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Conflict Resolution Modal -->
    <div id="conflict-resolution-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Class Conflicts Detected</h2>
            <div id="conflict-details">
                <!-- Conflict details will be added here dynamically -->
            </div>
            <div id="conflict-actions" class="dialog-actions">
                <!-- Action buttons will be added here dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Save Class Collection Modal -->
    <div id="save-class-collection-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Save Class Collection</h2>
            <form id="save-class-collection-form">
                <div class="form-group">
                    <label for="class-collection-name">Collection Name*</label>
                    <input type="text" id="class-collection-name" required>
                </div>
                <div class="form-group">
                    <label for="class-collection-description">Description (optional)</label>
                    <textarea id="class-collection-description"></textarea>
                </div>
                <div class="dialog-actions">
                    <button type="submit" class="btn">Save</button>
                    <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Load Class Collection Modal -->
    <div id="load-class-collection-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Saved Class Collections</h2>
            <div id="saved-class-collections-list" class="saved-schedules-container">
                <!-- Saved class collections will be added here dynamically -->
            </div>
        </div>
    </div>
    
    <!-- Class Collection Conflict Resolution Modal -->
    <div id="class-collection-conflict-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Class Differences Detected</h2>
            <div id="class-collection-conflict-details">
                <!-- Conflict details will be added here dynamically -->
            </div>
            <div id="class-collection-conflict-actions" class="dialog-actions">
                <!-- Action buttons will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- What-If Analysis Modal (Completely Rebuilt) -->
    <div id="what-if-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto; padding: 20px 0;">
        <div style="width: 700px; max-width: 90%; margin: 20px auto; background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; padding: 25px; overflow-y: auto; max-height: 80vh;">
            <span class="close" style="position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer;">&times;</span>
            
            <h2 style="margin-top: 5px; margin-bottom: 10px;">What-If Analysis</h2>
            <p style="margin-bottom: 20px;">
                Adjust constraints to see how they might affect your schedule quality.
            </p>
            
            <div style="background-color: #f9f9f9; border-radius: 5px; padding: 20px; margin: 15px 0; width: 100%; box-sizing: border-box;">
                <div style="margin-bottom: 25px;">
                    <label for="what-if-consecutive" style="display: block; margin-bottom: 10px;">Max Consecutive Classes:</label>
                    <div style="display: flex; align-items: center;">
                        <span id="what-if-consecutive-value" style="font-weight: bold; font-size: 18px; margin-right: 15px; min-width: 25px;">2</span>
                        <input type="range" id="what-if-consecutive" min="1" max="4" value="2" style="flex: 1; height: 10px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label for="what-if-daily" style="display: block; margin-bottom: 10px;">Max Classes Per Day:</label>
                    <div style="display: flex; align-items: center;">
                        <span id="what-if-daily-value" style="font-weight: bold; font-size: 18px; margin-right: 15px; min-width: 25px;">4</span>
                        <input type="range" id="what-if-daily" min="1" max="8" value="4" style="flex: 1; height: 10px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <label for="what-if-weekly-min" style="display: block; margin-bottom: 10px;">Weekly Class Target (Min):</label>
                    <div style="display: flex; align-items: center;">
                        <span id="what-if-weekly-min-value" style="font-weight: bold; font-size: 18px; margin-right: 15px; min-width: 25px;">12</span>
                        <input type="range" id="what-if-weekly-min" min="4" max="30" value="12" style="flex: 1; height: 10px;">
                    </div>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <label for="what-if-weekly-max" style="display: block; margin-bottom: 10px;">Weekly Class Target (Max):</label>
                    <div style="display: flex; align-items: center;">
                        <span id="what-if-weekly-max-value" style="font-weight: bold; font-size: 18px; margin-right: 15px; min-width: 25px;">16</span>
                        <input type="range" id="what-if-weekly-max" min="4" max="30" value="16" style="flex: 1; height: 10px;">
                    </div>
                </div>
            </div>
            
            <!-- Simulation results container -->
            <div style="padding: 10px 0; margin: 20px 0; width: 100%; box-sizing: border-box;">
                <h3 style="margin-top: 0; margin-bottom: 15px;">Simulation Results</h3>
                <div id="what-if-status" style="padding: 15px; background-color: #f5f5f5; border-radius: 5px; margin-bottom: 15px;">
                    <div class="status-message">Adjust constraints and click "Simulate" to see potential impact</div>
                </div>
                
                <div id="what-if-results" style="display: none; padding: 15px; background-color: #f9f9f9; border-radius: 5px; border-left: 4px solid #2196f3;">
                    <!-- Results will be shown here -->
                </div>
            </div>
            
            <!-- Action buttons -->
            <div style="display: flex; justify-content: space-between; padding: 15px 0; margin-top: 30px; border-top: 1px solid #eee; width: 100%;">
                <button id="what-if-simulate-btn" style="padding: 12px 24px; background-color: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Simulate Changes</button>
                <div class="what-if-advanced-actions" style="display: none; gap: 10px;">
                    <button id="what-if-apply-btn" style="padding: 12px 24px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Apply Changes</button>
                    <button id="what-if-cancel-btn" style="padding: 12px 24px; background-color: #9e9e9e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal">
        <div class="modal-content analytics-modal-content">
            <span class="close">&times;</span>
            <h2>Schedule Analytics</h2>
            
            <div class="analytics-dashboard">
                <div class="metrics-overview">
                    <div class="metric-card">
                        <h3>Schedule Span</h3>
                        <div class="metric-value" id="metric-span">0 days</div>
                        <div class="metric-detail" id="metric-span-detail"></div>
                    </div>
                    
                    <div class="metric-card">
                        <h3>Balance Score</h3>
                        <div class="metric-value" id="metric-balance">0%</div>
                        <div class="metric-gauge" id="balance-gauge">
                            <div class="gauge-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <h3>Overall Quality</h3>
                        <div class="metric-value" id="metric-quality">0%</div>
                        <div class="metric-gauge" id="quality-gauge">
                            <div class="gauge-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-header">
                    <h3>Schedule Visualization</h3>
                    <div class="view-controls">
                        <select id="analytics-view-selector">
                            <option value="heatmap">Class Distribution</option>
                            <option value="periods">Period Utilization</option>
                            <option value="constraints">Constraint Pressure</option>
                        </select>
                    </div>
                </div>
                
                <div class="visualization-container" id="analytics-visualization">
                    <!-- Visualization will be rendered here -->
                </div>
                
                <div class="analytics-insights">
                    <h3>Schedule Insights</h3>
                    <div id="analytics-insights-content" class="insights-content">
                        <!-- Insights will be displayed here -->
                    </div>
                </div>
                
                <div class="analytics-suggestions">
                    <h3>Optimization Suggestions <span class="badge beta-badge">Beta</span></h3>
                    <p class="suggestions-description">Analyze your schedule for potential improvements and receive personalized optimization suggestions.</p>
                    <button id="generate-suggestions-btn" class="btn">Generate Suggestions</button>
                    <div id="suggestions-container" class="suggestions-container">
                        <!-- Suggestions will be shown here -->
                    </div>
                    <div class="what-if-container">
                        <button id="show-what-if-btn" class="btn">What-If Analysis</button>
                        <span class="beta-badge">New</span>
                    </div>
                    <div class="suggestions-footer">
                        <p class="suggestions-note">Note: Suggestions are based on general optimization principles and may not apply to all scheduling contexts.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="src/data.js"></script>
    <script src="src/scheduler.js"></script>
    <script src="src/library-loader.js"></script>
    <script src="src/solver-wrapper.js"></script>
    <script src="src/analytics.js"></script>
    <script src="src/app.js"></script>
    <script src="src/class-manager.js"></script>
    
    <!-- Fix modal display -->
    <script>
        // Override the display style behavior for all modals
        document.addEventListener('DOMContentLoaded', function() {
            // Get all modals
            const modals = document.querySelectorAll('.modal');
            const whatIfModal = document.getElementById('what-if-modal');
            
            // Fix all modal show/hide behavior
            modals.forEach(modal => {
                // Handle What-If modal separately
                if (modal.id === 'what-if-modal') {
                    return; // Skip - we'll handle it separately
                }
                
                // Create an observer to monitor style changes
                const observer = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        if (mutation.attributeName === 'style') {
                            // When display is set to 'block', use our flex layout instead
                            if (modal.style.display === 'block') {
                                modal.style.display = 'flex';
                                modal.classList.add('show');
                            } else if (modal.style.display === 'none') {
                                modal.classList.remove('show');
                            }
                        }
                    });
                });
                
                // Start observing
                observer.observe(modal, { attributes: true });
                
                // Fix all close buttons
                const closeButtons = modal.querySelectorAll('.close');
                closeButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                    });
                });
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                    }
                });
            });
            
            // Special handling for What-If modal
            if (whatIfModal) {
                // Create an observer to monitor style changes
                const whatIfObserver = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        if (mutation.attributeName === 'style') {
                            if (whatIfModal.style.display === 'block') {
                                whatIfModal.classList.add('show');
                            } else if (whatIfModal.style.display === 'none') {
                                whatIfModal.classList.remove('show');
                            }
                        }
                    });
                });
                
                // Start observing
                whatIfObserver.observe(whatIfModal, { attributes: true });
                
                // Close button for What-If modal
                const whatIfCloseBtn = whatIfModal.querySelector('.close');
                if (whatIfCloseBtn) {
                    whatIfCloseBtn.addEventListener('click', function() {
                        whatIfModal.style.display = 'none';
                        whatIfModal.classList.remove('show');
                    });
                }
                
                // When the user clicks anywhere outside of the modal, close it
                whatIfModal.addEventListener('click', function(event) {
                    if (event.target === whatIfModal) {
                        whatIfModal.style.display = 'none';
                        whatIfModal.classList.remove('show');
                    }
                });
            }
        });
    </script>
    
    <!-- Initialize the What-If Analysis functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Set up What-If Simulate button handler with multiple fallbacks
            const simulateBtn = document.getElementById('what-if-simulate-btn');
            if (simulateBtn) {
                simulateBtn.addEventListener('click', function() {
                    try {
                        // Show loading state
                        this.disabled = true;
                        this.textContent = 'Simulating...';
                        
                        // Try multiple paths to access the function
                        let simulationCalled = false;
                        
                        // 1. Direct global function
                        if (typeof window.runWhatIfSimulation === 'function') {
                            console.log('Using global runWhatIfSimulation function');
                            simulationCalled = true;
                            Promise.resolve(window.runWhatIfSimulation())
                                .catch(err => console.error('Simulation error:', err))
                                .finally(() => {
                                    this.disabled = false;
                                    this.textContent = 'Simulate Changes';
                                });
                        }
                        // 2. Through whatIfAnalysis object
                        else if (window.whatIfAnalysis && typeof window.whatIfAnalysis.runSimulation === 'function') {
                            console.log('Using whatIfAnalysis.runSimulation function');
                            simulationCalled = true;
                            Promise.resolve(window.whatIfAnalysis.runSimulation())
                                .catch(err => console.error('Simulation error:', err))
                                .finally(() => {
                                    this.disabled = false;
                                    this.textContent = 'Simulate Changes';
                                });
                        }
                        
                        // If no method worked, show an error
                        if (!simulationCalled) {
                            console.error('No simulation function found, using fallback');
                            alert('Unable to run simulation. Please try again later.');
                            this.disabled = false;
                            this.textContent = 'Simulate Changes';
                        }
                    } catch (error) {
                        console.error('Error running What-If simulation:', error);
                        alert('An error occurred during simulation. Please try again later.');
                        this.disabled = false;
                        this.textContent = 'Simulate Changes';
                    }
                });
            }
        });
    </script>
</body>
</html>